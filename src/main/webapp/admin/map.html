<html>
    <head>
        <title>Cargo Live Map</title>
        <link rel="stylesheet" href="/cargo-tracker/css/lib/jquery-jvectormap-1.2.2.css" type="text/css" media="screen"/>
        <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="/cargo-tracker/javascript/lib/jquery-jvectormap-1.2.2.min.js"></script>
        <script src="/cargo-tracker/javascript/lib/jquery-jvectormap-world-mill-en.js"></script>
        <script type="text/javascript">
            var locationName = new Array();

            locationName["CNHKG"] = "Hong Kong";
            locationName["AUMEL"] = "Melbourne";
            locationName["SESTO"] = "Stockholm";
            locationName["FIHEL"] = "Helsinki";
            locationName["USCHI"] = "Chicago";
            locationName["JNTKO"] = "Tokyo";
            locationName["DEHAM"] = "Hamburg";
            locationName["CNSHA"] = "Shanghai";
            locationName["NLRTM"] = "Rotterdam";
            locationName["SEGOT"] = "Guttenburg";
            locationName["CNHGH"] = "Hangzhou";
            locationName["USNYC"] = "New York";
            locationName["USDAL"] = "Dallas";

            // TODO See if there is a service to get the latitude/longitude
            // data from.
            var latitude = new Array();

            latitude["CNHKG"] = 22;
            latitude["AUMEL"] = -38;
            latitude["SESTO"] = 59;
            latitude["FIHEL"] = 60;
            latitude["USCHI"] = 42;
            latitude["JNTKO"] = 36;
            latitude["DEHAM"] = 54;
            latitude["CNSHA"] = 31;
            latitude["NLRTM"] = 52;
            latitude["SEGOT"] = 58;
            latitude["CNHGH"] = 30;
            latitude["USNYC"] = 41;
            latitude["USDAL"] = 33;
            var longitude = new Array();
            longitude["CNHKG"] = 114;
            longitude["AUMEL"] = 145;
            longitude["SESTO"] = 18;
            longitude["FIHEL"] = 25;
            longitude["USCHI"] = -88;
            longitude["JNTKO"] = 140;
            longitude["DEHAM"] = 10;
            longitude["CNSHA"] = 121;
            longitude["NLRTM"] = 5;
            longitude["SEGOT"] = 12;
            longitude["CNHGH"] = 120;
            longitude["USNYC"] = -74;
            longitude["USDAL"] = -97;

            var colorCodes = new Array();

            colorCodes["NOT_ROUTED"] = "gray";
            colorCodes["MISROUTED"] = "red";
            colorCodes["NOT_RECEIVED"] = "white";
            colorCodes["IN_PORT"] = "green";
            colorCodes["ONBOARD_CARRIER"] = "green";
            colorCodes["MISDIRECTED"] = "red";
            colorCodes["AT_DESTINATION"] = "black";
            colorCodes["CLAIMED"] = "black";
            colorCodes["UNKNOWN"] = "red";
        </script>
    </head>
    <body>
        <div id="world-map" style="width: 800px; height: 600px"></div>
        <script type="text/javascript">
            $(function () {
                $.getJSON('/cargo-tracker/rest/cargo', function (data) {
                    var coordinates = new Array();

                    for (var i in data) {
                        cargo = data[i];
                        var locationCode = (cargo.transportStatus == 'NOT_RECEIVED') ? cargo.origin : cargo.lastKnownLocation;
                        var statusCode = 'NOT_RECEIVED';
                        if ((cargo.routingStatus == 'NOT_ROUTED') || (cargo.routingStatus == 'MISROUTED')) {
                            statusCode = cargo.routingStatus;
                        } else if (cargo.misdirected == true) {
                            statusCode = 'MISDIRECTED';
                        } else if (cargo.atDestination == true) {
                            statusCode = 'AT_DESTINATION';
                        } else {
                            statusCode = cargo.transportStatus;
                        }

                        coordinates.push(
                                {latLng: [latitude[locationCode] + (Math.floor((Math.random() * 3) - 3)),
                                        longitude[locationCode] + (Math.floor((Math.random() * 3) - 3))],
                                    name: cargo.trackingId,
                                    style: {fill: colorCodes[statusCode]}});
                    }

                    $('#world-map').vectorMap({
                        map: 'world_mill_en',
                        markers: coordinates,
                        onMarkerLabelShow: function (event, label, index) {
                            label.html(
                                    'Tracking ID: ' + data[index].trackingId + '<br/>' +
                                    'Routing Status: ' + data[index].routingStatus + '<br/>' +
                                    'Misdirected: ' + data[index].misdirected + '<br/>' +
                                    'Transport Status: ' + data[index].transportStatus + '<br/>' +
                                    'At Destination: ' + data[index].atDestination + '<br/>' +
                                    'Origin: ' + data[index].origin + '<br/>' +
                                    'Last known location: ' + data[index].lastKnownLocation);
                        }});
                });
            });
        </script>
        <script type="text/javascript">
            $(function () {
                var socket = new WebSocket("ws://localhost:8080/cargo-tracker/tracking");
                socket.onmessage = function (event) {
                    location.reload(true);
                };
            });
        </script>
    </body>
</html>